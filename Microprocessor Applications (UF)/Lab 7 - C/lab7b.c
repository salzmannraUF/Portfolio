/* Lab 7 Part B
* Name: Raymond Salzmann
*Section #: 2B04
* Description: Generating Waveform with DMA
* TA Name: Keith Fitzgerald
*/

#include <avr/io.h>
#include <avr/interrupt.h>
void CLK_INIT(void);
void DAC_INIT(void);
void TC_INIT(void);
void DMA_INIT(void);

ISR(TCC0_OVF_vect){
	TCC0_INTFLAGS = 0x01; //Clear overflow flag
	return;
}	

//lookup table acquired from the Internet for 256 values
int table[] = {0x800,0x832,0x864,0x896,0x8c8,0x8fa,0x92c,0x95e,
	0x98f,0x9c0,0x9f1,0xa22,0xa52,0xa82,0xab1,0xae0,
	0xb0f,0xb3d,0xb6b,0xb98,0xbc5,0xbf1,0xc1c,0xc47,
	0xc71,0xc9a,0xcc3,0xceb,0xd12,0xd39,0xd5f,0xd83,
	0xda7,0xdca,0xded,0xe0e,0xe2e,0xe4e,0xe6c,0xe8a,
	0xea6,0xec1,0xedc,0xef5,0xf0d,0xf24,0xf3a,0xf4f,
	0xf63,0xf76,0xf87,0xf98,0xfa7,0xfb5,0xfc2,0xfcd,
	0xfd8,0xfe1,0xfe9,0xff0,0xff5,0xff9,0xffd,0xffe,
	0xfff,0xffe,0xffd,0xff9,0xff5,0xff0,0xfe9,0xfe1,
	0xfd8,0xfcd,0xfc2,0xfb5,0xfa7,0xf98,0xf87,0xf76,
	0xf63,0xf4f,0xf3a,0xf24,0xf0d,0xef5,0xedc,0xec1,
	0xea6,0xe8a,0xe6c,0xe4e,0xe2e,0xe0e,0xded,0xdca,
	0xda7,0xd83,0xd5f,0xd39,0xd12,0xceb,0xcc3,0xc9a,
	0xc71,0xc47,0xc1c,0xbf1,0xbc5,0xb98,0xb6b,0xb3d,
	0xb0f,0xae0,0xab1,0xa82,0xa52,0xa22,0x9f1,0x9c0,
	0x98f,0x95e,0x92c,0x8fa,0x8c8,0x896,0x864,0x832,
	0x800,0x7cd,0x79b,0x769,0x737,0x705,0x6d3,0x6a1,
	0x670,0x63f,0x60e,0x5dd,0x5ad,0x57d,0x54e,0x51f,
	0x4f0,0x4c2,0x494,0x467,0x43a,0x40e,0x3e3,0x3b8,
	0x38e,0x365,0x33c,0x314,0x2ed,0x2c6,0x2a0,0x27c,
	0x258,0x235,0x212,0x1f1,0x1d1,0x1b1,0x193,0x175,
	0x159,0x13e,0x123,0x10a,0xf2,0xdb,0xc5,0xb0,
	0x9c,0x89,0x78,0x67,0x58,0x4a,0x3d,0x32,
	0x27,0x1e,0x16,0xf,0xa,0x6,0x2,0x1,
	0x0,0x1,0x2,0x6,0xa,0xf,0x16,0x1e,
	0x27,0x32,0x3d,0x4a,0x58,0x67,0x78,0x89,
	0x9c,0xb0,0xc5,0xdb,0xf2,0x10a,0x123,0x13e,
	0x159,0x175,0x193,0x1b1,0x1d1,0x1f1,0x212,0x235,
	0x258,0x27c,0x2a0,0x2c6,0x2ed,0x314,0x33c,0x365,
	0x38e,0x3b8,0x3e3,0x40e,0x43a,0x467,0x494,0x4c2,
	0x4f0,0x51f,0x54e,0x57d,0x5ad,0x5dd,0x60e,0x63f,
	0x670,0x6a1,0x6d3,0x705,0x737,0x769,0x79b,0x7cd};

int main(void)
{
	CLK_INIT();
	DAC_INIT();
	TC_INIT();
	DMA_INIT();
	
	while(1);
	
	return 0;
}

void CLK_INIT(void)
{
	OSC_CTRL = 0x02;
	
	while(!(OSC_STATUS & 0x02));
	
	CPU_CCP = 0xD8;
	
	CLK_CTRL = 0x01;
}void DAC_INIT(void){	DACA_CTRLC = 0x18; //Setting the reference to Port B AREF
	DACA_CTRLA = 0x05; //Setting the DAC to output to channel 0}void TC_INIT(void){	TCC0_CTRLA = 0x01; //Timer setting clk
	
	TCC0_PER = 0x01AA; //Approximately the time for 300 Hz
	
	TCC0_INTCTRLA= 0x01; //low overflow interrupt
	
	PMIC_CTRL = 0x01; //Enable low level interrupts
	
	sei();}void DMA_INIT(void){
		int16_t addr =(int16_t) & table;
		int16_t dest =(int16_t) & DACA_CH0DATA;
		
		DMA_CTRL = DMA_ENABLE_bm |
			DMA_PRIMODE_CH0123_gc; //0x83
			
		DMA_CH0_REPCNT= 0x00; 
		DMA_CH0_CTRLA= 0xA5;//Enabled,Repeat,Single,Burst 2 bytes
		
		DMA_CH0_ADDRCTRL= DMA_CH_SRCRELOAD_BLOCK_gc |
			DMA_CH_SRCDIR_INC_gc |
			DMA_CH_DESTRELOAD_BURST_gc |
			DMA_CH_DESTDIR_INC_gc ; //0x59
		
		DMA_CH0_TRIGSRC= 0x40;
		DMA_CH0_TRFCNT= 0x01FE;
		
		DMA_CH0_SRCADDR0 = addr;
		
		addr = addr >> 8;
		DMA_CH0_SRCADDR1 = addr;
		
		addr = addr >> 8;
		DMA_CH0_SRCADDR2 = addr;
		
		DMA_CH0_DESTADDR0 = dest;
		
		dest = dest >> 8;
		DMA_CH0_DESTADDR1 = dest;
		
		dest = dest >> 8;
		DMA_CH0_DESTADDR2= dest;
		
		return;}